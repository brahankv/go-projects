<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go File Server</title>
    <link rel="stylesheet" href="/static/style.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>

<body>
    <div class="mobile-header">
        <button id="menu-toggle" aria-label="Toggle Menu">
            <svg viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
        </button>
        <span style="font-weight: 600;">File Server</span>
        <div style="width: 40px;"></div> <!-- Spacer -->
    </div>

    <div class="menu-overlay" id="menu-overlay"></div>

    <div class="app-container">
        <div id="tree">
            <ul id="tree-root"></ul>
        </div>

        <div id="viewer">
            <!-- Navigation and Controls Area -->
            <div id="nav-info-panel" style="display:none; flex-direction: column;">
                <div id="nav-panel">
                    <div class="path-bar">
                        <h3 id="file-path"></h3>
                    </div>
                    <div class="toolbar">
                        <button id="prev-btn" disabled data-tooltip="Previous">
                            <svg viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                            </svg>
                        </button>
                        <button id="next-btn" disabled data-tooltip="Next">
                            <svg viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                            </svg>
                        </button>

                        <div style="flex:1"></div> <!-- Spacer -->

                        <button id="zoom-in-btn" style="display:none" data-tooltip="Zoom In">
                            <svg viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6" />
                            </svg>
                        </button>
                        <button id="zoom-out-btn" style="display:none" data-tooltip="Zoom Out">
                            <svg viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM7.5 10.5h6" />
                            </svg>
                        </button>
                        <button id="download-btn" class="primary" data-tooltip="Download">
                            <svg viewBox="0 0 24 24" style="margin-right:0;">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M12 12.75l4.286-4.286m-4.286 4.286L7.714 8.464M12 12.75V3" />
                            </svg>
                            <span style="font-size: 14px; margin-left: 6px;">Download</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div id="file-content-wrapper">
                <div id="empty-state" style="text-align:center; margin-top: 100px; color: #94a3b8;">
                    <p>Select a file to view content</p>
                </div>
                <pre id="file-content" style="display:none;"></pre>
            </div>
        </div>
    </div>

    <!-- Upload Feedback Panel -->
    <div id="upload-feedback-panel">
        <div class="upload-status-list" id="upload-list"></div>
        <button onclick="closeUploadPanel()" style="margin-left: 12px; border:none; color: #94a3b8;"
            data-tooltip="Close">
            <svg viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>

    <script>
        // --- Upload Status Logic ---
        let activeUploads = {}; // Store XHRs to allow cancellation

        function updateUploadStatus(filename, type, progress, msg) {
            const panel = document.getElementById('upload-feedback-panel');
            const list = document.getElementById('upload-list');
            panel.classList.add('visible');

            // Clean up completed/cancelled items logic could go here, 
            // but for now we append/update.

            // Sanitize filename for ID
            const fileId = 'upload-item-' + filename.replace(/[^a-zA-Z0-9]/g, '_');

            let item = document.getElementById(fileId);
            if (!item) {
                item = document.createElement('div');
                item.id = fileId;
                item.className = 'upload-item';

                // Structure: Info (Name + Bar) | Cancel
                item.innerHTML = `
                <div class="upload-info">
                    <div class="upload-name">${filename}</div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="upload-msg" style="font-size:11px; color:#64748b;">Waiting...</div>
                </div>
                <button class="upload-cancel-btn" onclick="cancelUpload('${filename}')" title="Cancel">
                    <svg viewBox="0 0 24 24" style="width:16px;height:16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            `;
                list.appendChild(item);
            }

            const bar = item.querySelector('.progress-bar');
            const msgDiv = item.querySelector('.upload-msg');
            const cancelBtn = item.querySelector('.upload-cancel-btn');
            const nameDiv = item.querySelector('.upload-name');

            bar.style.width = progress + '%';
            msgDiv.textContent = msg;

            item.classList.remove('pending', 'success', 'error');
            item.classList.add(type);

            if (type === 'success') {
                msgDiv.style.color = '#10b981';
                cancelBtn.style.display = 'none'; // Cannot cancel done
                delete activeUploads[filename];
            } else if (type === 'error') {
                msgDiv.style.color = '#ef4444';
                // Keep x to dismiss? Or change function. 
                // Let's repurpose cancel button to 'dismiss' or just hide it
                cancelBtn.style.display = 'none'; // Hide cancel on error too
                delete activeUploads[filename];
            }
        }

        function cancelUpload(filename) {
            if (activeUploads[filename]) {
                activeUploads[filename].abort();
                updateUploadStatus(filename, 'error', 0, 'Cancelled');
                delete activeUploads[filename];
            }
        }

        function closeUploadPanel() {
            document.getElementById('upload-feedback-panel').classList.remove('visible');
            document.getElementById('upload-list').innerHTML = '';
            activeUploads = {};
        }

        // Mobile Menu Toggle
        const menuToggle = document.getElementById('menu-toggle');
        const tree = document.getElementById('tree');
        const overlay = document.getElementById('menu-overlay');

        function toggleMenu() {
            tree.classList.toggle('open');
            overlay.classList.toggle('open');
        }

        menuToggle.addEventListener('click', toggleMenu);
        overlay.addEventListener('click', toggleMenu);

        // Close menu when clicking a link on mobile
        function closeMenuOnMobile() {
            if (window.innerWidth <= 768) {
                tree.classList.remove('open');
                overlay.classList.remove('open');
            }
        }

        let currentPath = "/";
        let inputFolders = [];
        let currentFolderFiles = [];
        let currentFileIndex = -1;

        function fetchTree(path = "/") {
            fetch(`/api/tree?path=${encodeURIComponent(path)}`)
                .then(res => res.json())
                .then(data => {
                    if (path === "/") {
                        inputFolders = data.map(f => f.path);
                    }
                    currentFolderFiles = data.filter(item => item.type === 'file');
                    renderTree(data, path);
                });
        }

        function renderTree(data, path) {
            currentPath = path;
            const root = document.getElementById('tree-root');
            root.innerHTML = '';

            // --- Input folders at the top ---
            if (inputFolders.length) {
                const inputHeader = document.createElement('div');
                inputHeader.className = 'section-header';
                inputHeader.textContent = 'Root Folders';
                root.appendChild(inputHeader);

                inputFolders.forEach(f => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${f.split("/").filter(Boolean).slice(-1)[0] || f}</span>`;
                    li.className = 'folder';
                    li.onclick = (e) => {
                        e.stopPropagation();
                        fetchTree(f);
                    };
                    root.appendChild(li);
                });

                const sep = document.createElement('hr');
                sep.style.border = 'none';
                sep.style.borderBottom = '1px solid var(--border-color)';
                sep.style.margin = '12px 0';
                root.appendChild(sep);
            }

            // --- Current folder controls ---
            if (path !== "/") {
                // Find base input folder
                let baseFolder = inputFolders.find(f => path.startsWith(f));
                let relPath = baseFolder ? path.slice(baseFolder.length) : path;
                if (relPath.startsWith('/')) relPath = relPath.slice(1);
                let displayPath = baseFolder ? (baseFolder.split('/').filter(Boolean).slice(-1)[0] + (relPath ? '/' + relPath : '')) : path;

                // Current Folder Section
                const curSection = document.createElement('div');
                curSection.style.padding = '8px 12px';
                curSection.style.background = 'var(--bg-color)';
                curSection.style.borderRadius = '6px';
                curSection.style.marginBottom = '12px';

                const sectionTitle = document.createElement('div');
                sectionTitle.className = 'section-header';
                sectionTitle.textContent = 'Current Folder';
                curSection.appendChild(sectionTitle);

                const pathDisplay = document.createElement('div');
                pathDisplay.textContent = displayPath;
                pathDisplay.style.fontWeight = '500';
                pathDisplay.style.fontSize = '13px';
                pathDisplay.style.marginBottom = '8px';
                pathDisplay.style.wordBreak = 'break-all';
                curSection.appendChild(pathDisplay);

                const actionsDiv = document.createElement('div');
                actionsDiv.style.display = 'flex';
                actionsDiv.style.gap = '8px';
                actionsDiv.style.flexWrap = 'wrap';

                // Up Button
                const upBtn = document.createElement('button');
                upBtn.innerHTML = '<svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" /></svg>';
                upBtn.setAttribute('data-tooltip', 'Go Up');
                upBtn.onclick = goUp;
                let canGoUp = true;
                if (inputFolders.includes(path) || path === "/") canGoUp = false;
                upBtn.disabled = !canGoUp;
                actionsDiv.appendChild(upBtn);

                // Upload
                // Upload
                const uploadLabel = document.createElement('label');
                uploadLabel.className = 'button primary';
                uploadLabel.style.display = 'inline-flex';
                uploadLabel.style.alignItems = 'center';
                uploadLabel.style.cursor = 'pointer';

                uploadLabel.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision" text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd" clip-rule="evenodd" viewBox="0 0 512 379.661" style="margin-right:6px;width:20px;height:20px;fill:currentColor;stroke:none;"><path fill-rule="nonzero" d="M153.764 151.353c-7.838-.333-13.409-2.935-16.619-7.822-8.724-13.076 3.18-25.997 11.443-35.099 23.441-25.725 80.888-87.554 92.454-101.162 8.768-9.693 21.25-9.693 30.017 0 11.948 13.959 72.287 78.604 94.569 103.628 7.731 8.705 17.292 20.579 9.239 32.633-3.287 4.887-8.798 7.489-16.636 7.822H310.65v96.177c0 12.558-10.304 22.868-22.871 22.868h-63.544c-12.572 0-22.871-10.294-22.871-22.868v-96.177h-47.6zm-153 97.863c-2.622-10.841 1.793-19.33 8.852-24.342a24.767 24.767 0 018.47-3.838c3.039-.738 6.211-.912 9.258-.476 8.585 1.232 16.409 6.775 19.028 17.616a668.81 668.81 0 014.56 20.165 1259.68 1259.68 0 013.611 17.72c4.696 23.707 8.168 38.569 16.924 45.976 9.269 7.844 26.798 10.55 60.388 10.55h254.297c31.012 0 47.192-2.965 55.706-10.662 8.206-7.418 11.414-21.903 15.564-44.131a1212.782 1212.782 0 013.628-18.807c1.371-6.789 2.877-13.766 4.586-20.811 2.619-10.838 10.438-16.376 19.023-17.616 3.02-.434 6.173-.256 9.212.474 3.071.738 5.998 2.041 8.519 3.837 7.05 5.007 11.457 13.474 8.855 24.294l-.011.046a517.834 517.834 0 00-4.181 18.988c-1.063 5.281-2.289 11.852-3.464 18.144l-.008.047c-6.124 32.802-11.141 55.308-27.956 71.112-16.565 15.572-42.513 22.159-89.473 22.159H131.857c-49.096 0-76.074-5.911-93.429-21.279-17.783-15.75-23.173-38.615-30.047-73.314-1.39-7.029-2.728-13.738-3.638-18.091-1.281-6.11-2.6-12.081-3.979-17.761z"/></svg>Upload`;

                const uploadInput = document.createElement('input');
                uploadInput.type = 'file';
                uploadInput.multiple = true;
                uploadInput.addEventListener('change', function (e) {
                    if (!uploadInput.files.length) return;
                    // Convert FileList to Array to allow foreach
                    const files = Array.from(uploadInput.files);
                    files.forEach(file => uploadSingleFile(path, file));

                    // Reset input so same file can be selected again if needed
                    uploadInput.value = '';
                });

                uploadLabel.appendChild(uploadInput);
                actionsDiv.appendChild(uploadLabel);

                curSection.appendChild(actionsDiv);
                root.appendChild(curSection);
            }

            // --- Tree Items ---
            data.forEach(item => {
                if (inputFolders.includes(item.path)) return;
                const li = document.createElement('li');
                li.innerHTML = `<span>${item.name}</span>`;
                li.className = item.type;
                li.onclick = (e) => {
                    e.stopPropagation();
                    if (item.type === 'folder') {
                        fetchTree(item.path);
                    } else {
                        viewFile(item.path, item.name);
                        closeMenuOnMobile();
                    }
                };
                root.appendChild(li);
            });
        }

        function uploadSingleFile(folderPath, file) {
            updateUploadStatus(file.name, 'pending', 0, 'Starting...');

            const formData = new FormData();
            formData.append('files', file); // API expects 'files' array even for one
            // Folder is now sent via URL query param to allow streaming on backend

            const xhr = new XMLHttpRequest();
            activeUploads[file.name] = xhr;

            // Progress listener
            xhr.upload.addEventListener("progress", function (e) {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    updateUploadStatus(file.name, 'pending', percentComplete, Math.round(percentComplete) + '%');
                }
            }, false);

            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        // Check if response is JSON with error
                        try {
                            const resp = JSON.parse(xhr.responseText);
                            if (resp.success) {
                                updateUploadStatus(file.name, 'success', 100, 'Done');
                                // Refresh tree if current folder matches
                                if (currentPath === folderPath) fetchTree(folderPath);
                            } else {
                                updateUploadStatus(file.name, 'error', 0, resp.error || 'Failed');
                            }
                        } catch (e) {
                            updateUploadStatus(file.name, 'success', 100, 'Done'); // Assume success if 200 OK text?
                            if (currentPath === folderPath) fetchTree(folderPath);
                        }
                    } else {
                        // Abort is status 0 typically
                        if (xhr.status !== 0) {
                            updateUploadStatus(file.name, 'error', 0, 'Error ' + xhr.status);
                        }
                    }
                }
            };

            xhr.onerror = function () {
                updateUploadStatus(file.name, 'error', 0, 'Network Error');
            };

            // Append folder to query string
            xhr.open("POST", "/api/upload?folder=" + encodeURIComponent(folderPath), true);
            xhr.send(formData);
        }

        function goUp() {
            if (inputFolders.includes(currentPath) || currentPath === "/") return;
            const parts = currentPath.split("/").filter(Boolean);
            parts.pop();
            let parent = "/" + parts.join("/");
            if (inputFolders.includes(parent)) {
                fetchTree(parent);
                return;
            }
            fetchTree(parent);
        }

        function viewFile(path, name) {
            const idx = currentFolderFiles.findIndex(x => x.path === path);
            if (idx !== -1) {
                currentFileIndex = idx;
            }
            updateFileView(path, name);
        }

        function navigateFile(offset) {
            const newIndex = currentFileIndex + offset;
            if (newIndex >= 0 && newIndex < currentFolderFiles.length) {
                currentFileIndex = newIndex;
                const file = currentFolderFiles[currentFileIndex];
                updateFileView(file.path, file.name);
            }
        }

        function updateFileView(path, name) {
            // UI Prep
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('nav-info-panel').style.display = 'flex';

            fetch(`/api/file?path=${encodeURIComponent(path)}`)
                .then(res => res.json())
                .then(data => {
                    const wrapper = document.getElementById('file-content-wrapper');
                    const children = Array.from(wrapper.children);
                    children.forEach(c => {
                        if (c.id !== 'empty-state') wrapper.removeChild(c);
                    });

                    const zoomInBtn = document.getElementById('zoom-in-btn');
                    const zoomOutBtn = document.getElementById('zoom-out-btn');
                    let zoom = 1;

                    if (data.type === 'error') {
                        const msg = document.createElement('div');
                        msg.style.padding = '20px';
                        msg.style.color = '#ef4444';
                        msg.style.background = '#fef2f2';
                        msg.style.border = '1px solid #fecaca';
                        msg.style.borderRadius = '8px';
                        msg.style.textAlign = 'center';
                        msg.textContent = data.content;
                        wrapper.appendChild(msg);

                        zoomInBtn.style.display = 'none';
                        zoomOutBtn.style.display = 'none';
                    }
                    else if (data.type === 'pdf') {
                        const iframe = document.createElement('iframe');
                        iframe.src = data.content; // The raw URL
                        iframe.style.width = '100%';
                        iframe.style.height = '80vh';
                        iframe.style.border = 'none';
                        wrapper.appendChild(iframe);

                        zoomInBtn.style.display = 'none';
                        zoomOutBtn.style.display = 'none';
                    } else if (data.type === 'image') {
                        const img = document.createElement('img');
                        img.src = data.content;
                        img.alt = name;
                        img.style.maxWidth = '100%';
                        img.style.maxHeight = '100%';
                        img.style.objectFit = 'contain';
                        img.style.display = 'block';
                        img.style.margin = '0 auto';

                        wrapper.appendChild(img);

                        zoomInBtn.style.display = 'inline-flex';
                        zoomOutBtn.style.display = 'inline-flex';

                        zoomInBtn.onclick = function () {
                            zoom = Math.min(zoom + 0.2, 5);
                            img.style.transform = `scale(${zoom})`;
                        };
                        zoomOutBtn.onclick = function () {
                            zoom = Math.max(zoom - 0.2, 0.2);
                            img.style.transform = `scale(${zoom})`;
                        };
                    } else {
                        const code = document.createElement('pre');
                        code.id = 'file-content';
                        code.className = data.language || '';
                        code.textContent = data.content;
                        wrapper.appendChild(code);

                        zoomInBtn.style.display = 'none';
                        zoomOutBtn.style.display = 'none';
                    }

                    // Update Header
                    let baseFolder = inputFolders.find(f => path.startsWith(f));
                    let relPath = baseFolder ? path.slice(baseFolder.length) : path;
                    if (relPath.startsWith('/')) relPath = relPath.slice(1);
                    let displayPath = baseFolder ? (baseFolder.split('/').filter(Boolean).slice(-1)[0] + (relPath ? '/' + relPath : '')) : path;

                    document.getElementById('file-path').textContent = displayPath;

                    // Update Buttons
                    const btn = document.getElementById('download-btn');
                    btn.onclick = () => window.location = `/api/download?path=${encodeURIComponent(path)}`;

                    const prevBtn = document.getElementById('prev-btn');
                    const nextBtn = document.getElementById('next-btn');

                    // Use cached list for enable/disable
                    prevBtn.disabled = (currentFileIndex <= 0);
                    nextBtn.disabled = (currentFileIndex === -1 || currentFileIndex >= currentFolderFiles.length - 1);

                    prevBtn.onclick = () => navigateFile(-1);
                    nextBtn.onclick = () => navigateFile(1);
                });
        }

        fetchTree();
    </script>
</body>

</html>